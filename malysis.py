# T.Y BSC (Cyber Security) | Semester-V
# Mini Project (Malware/Cryptography) | Course Code : CS-317
# Title : Static malware Analysis using Python

#---------------------------------------------------------------------------------------------------------------------------------------------------------

# Project Banner

import pyfiglet as fig
#for banner printing
import time as tm
#for time related functions
from colorama import Fore, Back, Style
#for font style
import sys
#for system related functions
import hashlib
#for generating hashes of files
import tkinter as tk
#for GUI

print()
print(Fore.YELLOW + "Hello World...")
print("T.Y BSC (Cyber Security) | Semester-V")
print("Mini Project (Malware/Cryptography) | Course Code : CS-317")
print("Project Title : Static Malware Anlysis using Python.\n")

banner = fig.figlet_format("||_Malysis_||")
print(Fore.GREEN + banner)
print(Style.RESET_ALL)
                            
print(Fore.YELLOW + "Dev Team : A22 Ketan Mote & A63 Sourabh Pradhan")                                                                                     
print("Codename : Malysis")                                                                                                                   
print("Version  : 0.0.1")                                                                                                                   
print("Contact  : +91 9696699696 / ouremail@mail.com") 
print(Style.RESET_ALL)

print("----------------------------------------------------------------------------------------------------------------------------------")

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------

# GUI for File Input and Report Name Input
m=tk.Tk()
e1=tk.StringVar()
e2=tk.StringVar()
e3=tk.StringVar()

m.title("MALWARE ANALYZER (Malysis)")

l1=tk.Label(m,text="Enter File Name", width=40, height=3)
l1.pack()

t1=tk.Entry(m,textvariable=e1,width=20)
t1.pack()

l2=tk.Label(m,text="Enter Report Name",width=40, height=3)
l2.pack()

t2=tk.Entry(m,textvariable=e2,width=20)
t2.pack()

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Command Line or Terminal Interphase
def inp():
    for arg in sys.argv:
        if arg=="--help":
            print("\nTO PERFORM ANALYSIS : python3 analysis.py <MALWARE FILE>\n")
            sys.exit(0)
    
    global malware,hosts,rep_name
    malware=str(e1.get())
    rep_name=str(e2.get())
    if not rep_name:
        rep_name="default.txt"

    try:
        hosts=open(malware,'r').readlines()
    except (IOError):
        print("\nUsage    : ./analyse.py <MALWARE FILENAME>")
        print("\nFOR HELP : ./analyse.py --help")
        print("\nMALWARE MISSING OR FILE DOES NOT EXIST.")
        print("\nExiting...")
        sys.exit(0)
    m.destroy()


#----------------------------------------------------------------------------------------------------------------------------------------------------------

# GUI based Start Process 
b1=tk.Button(m,text="START PROCESSING",width=60,command=inp)
b1.pack()

m.mainloop()

#----------------------------------------------------------------------------------------------------------------------------------------------------------

#Importing Essential Packages
import os
import sys
import re,string #perform signature analysis 
import time as tm

#----------------------------------------------------------------------------------------------------------------------------------------------------------
 
# Intresting Calls Signature List
INTERESTING_CALLS=["CreateMutex","CopyFile","CreateFile.*WRITE","NtasdfCreateFile","call shell32","advapi32.RegOpenKey","KERNEL32.CreateProcess","shdocvw","gethostbyname","ws2_32.bind","ws2_32.listen","ws2_32.htons","advapi32.RegCreate","advapi32.RegSet","Socket","OutputDebugString","GetEnvironmentStrings","LoadLibraryA","WSASocketA","GetProcAddress","FindWindow","CreateProcess","DuplicateTokenEx","signal","IdDebuggerPresent","STARTUPINFO()","GetLogicalDriveStrings()",".run([powershell code] stdout=subprocess.PIPE stderr=subprocess.STDOUT shell=True)","CommitSuicide()","RunAsAdmin()","IsPyExist()","os.path.join(root, file)"," th.start()"]


# DLL Calls Signature List
DLL_CALLS=["KERNEL.DLL","advapi32.dll","comctl32.dll","gdi32.dll","ole32.dll","oleaut32.dll","user32.dll","wsock32.dll","ntdll.dll","win32api","kernel32"]

# System Calls Signature List
SYS_CALLS=["ping.exe","telnet.exe","vmsrvc.exe" , "vmusrvc.exe", "vboxtray.exe", "vmtoolsd.exe", "df5serv.exe", "vboxservice.exe"]

# IRC Signature List
IRC_COMMANDS=["IRC","Joined Channel","Port","Bot","Login","flood","ddos","NICK","ECHO","ADMIN","CONNECT","PING","SERVICE","INFO","WHO","WHOIS","VERSION","requests.packages.urllib3.disable_warnings()",".com","192.168.202.1","4567","socket.socket(socket.AF_INET, socket.SOCK_STREAM)","client.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)"," client.recv(2048)","socket.SO_REUSEADDR",]

# Registry Calls Signature List
REGISTRY_CALLS=["HKEY_CURRENT_USER","HKEY_CLASSES_ROOT","HKEY_LOCAL_MACHINE","autorun.inf","REG ADD","REG_DWORD","DisableRegistryTools","DisableTaskMgr","DisableCMD","SintaRegistery","addRegistery"]

# Cryptography Functions Signature List
CRYPTO=["lstrcmpA","CryptGetUserKey","CryptExportKey","CryptDestoryKey","CryptReleaseContext","AES","Crypto","tool.encrypt(data)","Fernet","cryptography.fernet","base64","hazmat.backends","hazmat.primitives","PBKDF2HMAC","hashes.SHA256()","base64.urlsafe_b64encode(kdf.derive(password))","otp.decode()","secret.decode()","Fernet.generate_key()","0.0.0.0","4567"]

# Spread Signature List
SPREAD=["FindFirstFileA","lstrcmpiA","FindNextFileA","FindClose","text_generator"]

# Extension Signature List
EXTEN=["txt","exe","php","pl","7z","py"]

# Location Signature List
LOC=["cipher /W:%s","CurrentVersion","Policies","HKEY_LOCAL_MACHINE","SYSTEM","Control","Terminal Server","c:/"]

#-------------------------------------------------------------------------------------------------------------------------------------------------------

# Matching the Signature Lists string with Files strings

# Matching Extension Signatures
def exten():
    global f1
    f1=0
    for line in hosts:
        for calls in EXTEN:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] ACCESSING FILE WITH EXTENSIONS",calls)
                print(Style.RESET_ALL)
                ext.append(calls)
                f1=1

# Matching Location Signatures
def loc():
    global f2
    f2=0
    for line in hosts:
        for calls in LOC:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] ACCESSING/MODIFYING LOCATION", calls)
                print(Style.RESET_ALL)
                lo.append(calls)
                f2=1

# Matching Cryptographic Function signatures
def crypto():
    global f3
    f3=0
    for line in hosts:
        for calls in CRYPTO:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] MAYBE RANSOMEWARE ", calls)
                print(Style.RESET_ALL)
                cryp.append(calls)
                f3=1


# Matching Spread Signatures
def spread():
    global f9
    f9=0
    for line in hosts:
        for calls in SPREAD:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] SHOWINNG SIGNS OF WORMS ",calls)
                print(Style.RESET_ALL)
                wor.append(calls)
                f9=1

# Matching Intresting calls Signatures
def start_analyse_system_calls():
    performed=[]
    global f4
    f4=0
    for line in hosts:
        for calls in INTERESTING_CALLS:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] Found an INTERESTING CALL to",calls)
                print(Style.RESET_ALL)
                performed.append(calls)
                i_calls.append(calls)
                f4=1

# Matching Registry Calls Signatures
def start_analysis_registry():
    global f5
    f5=0
    for line in hosts:
        for calls in REGISTRY_CALLS:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] MALWARE IS ADDING/MODIFYING HIVES",calls)
                print(Style.RESET_ALL)
                print(line)
                regi.append(calls)
                f5=1

# Matching DLL Calls Signatures
def calls_to_dlls():
    global f6
    f6=0
    for line in hosts:
        for calls in DLL_CALLS:
            if re.search(calls,line):
                print(Fore.BLUE + "\n[+] Loaded Dll:",calls)
                print(Style.RESET_ALL)
                dll.append(calls)
                f6=1
                
# Matching System Calls Signatures
def calls_to_sys():
    global f7
    f7=0
    for line in hosts:
        for calls in SYS_CALLS:
            if re.search(calls,line):
                print(Fore.BLUE + "\n[+] CALL MADE: ",calls)
                print(Style.RESET_ALL)
                #print("\n[+] It can be part od DDOS \n")
                sys_calls.append(calls)
                f7=1

# Matching IRC Signatures
def start_alanysis_online():
    performed=[]
    global f8
    f8=0
    for line in hosts:
        for calls in IRC_COMMANDS:
            if re.search(calls,line):
                print(Fore.BLUE + "[+] SEEMS TO BE IRC BOT",calls)
                print(Style.RESET_ALL)
                performed.append(calls)
                irc.append(calls)
                f8=1

# Checking File is PE or Not
def checkPE():
    print(Fore.RED +  "\n[+] Analysing if PE File\n")
    print(Style.RESET_ALL)
    check=open(malware, "rb")
    buff = check.read(2)
    check.close()

    if buff =="MZ":
        print(Fore.BLUE + "\n[!] VALID PE FILE.")
        print(Style.RESET_ALL)

    else:
        print(Fore.BLUE + "[!] NOT PE ")
        print(Style.RESET_ALL)
        

#------------------------------------------------------------------------------------------------------------------------------------------------------

# Analysis process function
mcnt=0
def apps_start():
    #inputf()
    tm.sleep(2)

    checkPE()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print((Fore.RED + "\n[!] Displaying Interesting CALLS MADE.\n"))
    print(Style.RESET_ALL)
    start_analyse_system_calls()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!]  DISPLAYING Registry Hives Edited.\n")
    print(Style.RESET_ALL)
    start_analysis_registry()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] ONLINE BEHAVIOUR.\n")
    print(Style.RESET_ALL)
    start_alanysis_online()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] DISPLAY LOADED DLLS.\n")
    print(Style.RESET_ALL)
    calls_to_dlls()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] Commands inside MAlware.\n")
    print(Style.RESET_ALL)
    calls_to_sys()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] TRYING TO ACCESS FILE OF EXTENSION.\n") 
    print(Style.RESET_ALL)
    exten()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)

    print(Fore.RED + "\n[!] LOCATION ACCESSING.\n")
    print(Style.RESET_ALL)
    loc()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] CRYPTOGRAPHIC FUNCTIONS.\n")
    print(Style.RESET_ALL)
    crypto()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)
    
    print(Fore.RED + "\n[!] SIGNATURE FOR WORMS.\n")
    print(Style.RESET_ALL)
    spread()
    print("//////////////////////////////////////////////////////////////////////////////////////////////////////////////////")
    tm.sleep(2)

#----------------------------------------------------------------------------------------------------------------------------------------------------------------

# Printing the Output of the Report

i_calls=[]
sys_calls=[]
irc=[]
cryp=[]
wor=[]
dll=[]
regi=[]
lo=[]
ext=[]

apps_start()

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------

# Creating the Report of the analysis
#def report():
rep=rep_name
fr=open(rep,"w")

fr.write("MALWARE STATIC ANALYSIS REPORT\n")
fr.write("")
fr.write("------------------------------------------------------------------------------------------------------------------------------------------------------\n")
fr.write("Dev Team : Ketan Mote & Sourabh Pradhan\n")                                                                                     
fr.write("Codename : MalHunt\n")                                                                                                                   
fr.write("Version  : 0.0.1\n")                                                                                                                   
fr.write("Contact  : +91 545874745 / ouremail@gmail.com\n")
fr.write("------------------------------------------------------------------------------------------------------------------------------------------------------\n")
fr.write("# Basic Details about File : \n")
fr.write("\n")
fr.write(" 1. NAME of the File : ")
fr.write(malware)
fr.write("\n")
f_n,f_exten=os.path.splitext(malware)
f_s=os.stat(malware)
size=(f_s.st_size)
fr.write(" 2. File Size (in bytes) : ")
si=str(size)
fr.write(si)
fr.write("\n")
#print(size, "byte")
with open(malware,"rb") as f:
    bytes=f.read()
    md_5=hashlib.md5(bytes).hexdigest()
    fr.write("\n 3. MD5 HASH : \n")
    fr.write(md_5)

    #print(md_5)
    sha_256=hashlib.sha256(bytes).hexdigest()
    fr.write("\n 4. SHA256 HASH : \n")
    fr.write(sha_256)
    #print(sha_256)
    sha_512=hashlib.sha512(bytes).hexdigest()
    fr.write("\n 5. SHA512 HASH : \n")
    fr.write(sha_512)
    f.close()

fr.write("\n----------------------------------------------------------------------------------------------------------------------------------------------------\n")

fr.write("# Malware Signature Analysis :\n")

fr.write("\n 1. INTRESTING CALLS :\n ")
fr.write(str(i_calls))
fr.write("\n")

fr.write("\n 2. SYSTEM CALLS :\n ")
fr.write(str(sys_calls))
fr.write("\n")

fr.write("\n 3. DLL CALLS :\n ")
fr.write(str(dll))
fr.write("\n")

fr.write("\n 4. REGISTRY CALLS :\n ")
fr.write(str(regi))
fr.write("\n")

fr.write("\n 5. IRC COMANDS :\n ")
fr.write(str(irc))
fr.write("\n")

fr.write("\n 6. CRYPTOGRAPHIC FUNCTIONS :\n")
fr.write(str(cryp))
fr.write("\n")

fr.write("\n 7. ENUMERATING AND SPREADING FUCTIONS :\n")
fr.write(str(wor))
fr.write("\n")

fr.write("\n 8. TRYING TO ACCESS/XECUTE/ENCRYPT FILE TYPES :\n")
fr.write(str(ext))
fr.write("\n")

fr.write("\n 9. TARGETED LOCATIONS :\n")
fr.write(str(lo))
fr.write("\n")

fr.write("\n----------------------------------------------------------------------------------------------------------------------------------------------------\n")

fr.write("\nEnd of the Report.\n")

fr.close()

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------

print("-----------------------------------------------------------------------------------------------------------------------------------------------------------")

print("Generating Report.....")
tm.sleep(1)
print("\nNOTE : Report has been generated with name ",rep)


#print(f1,f2,f3,f4,f5,f6,f7,f8,f9)
if(f1==1 or f2==1 or f3==1 or f4==1 or f5==1 or f6==1 or f7==1 or f8==1 or f9==1):
    print(Fore.RED + "\nWARNING : FILE IS MIGHT BE MALICIOUS. BE CAREFUL.")
    print(Style.RESET_ALL)
    
else:

    print(Fore.GREEN + "\nFILE IS NOT MALICIOUS.")
    print(Style.RESET_ALL)

print("\nExiting...")

#--------------------------------------------------------------------------------------------------------------------------------------------------------------
